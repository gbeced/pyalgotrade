

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tutorial &mdash; PyAlgoTrade 0.9 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="PyAlgoTrade 0.9 documentation" href="index.html" />
    <link rel="next" title="Google App Engine support" href="googleappengine.html" />
    <link rel="prev" title="Introduction" href="intro.html" />
 

<!-- Google analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1180709-11']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!-- End Google analytics -->


  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="googleappengine.html" title="Google App Engine support"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="Introduction"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">PyAlgoTrade 0.9 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<p>The goal of this tutorial is to give you a quick introduction to PyAlgoTrade.
As described in the introduction, the goal of PyAlgoTrade is to help you backtest stock trading strategies.
Let&#8217;s say you have an idea for a trading strategy and you&#8217;d like to evaluate it with historical data and see how it behaves,
then PyAlgoTrade should allow you to do so with minimal effort.</p>
<p>Before I move on I would like to thank Pablo Jorge who helped reviewing the design and documentation.</p>
<p><strong>This tutorial was developed on a UNIX environment, but the steps to adapt it to a Windows environment should be straightforward.</strong></p>
<p>The PyAlgoTrade library has 4 main components:</p>
<blockquote>
<div><ul class="simple">
<li>Strategies</li>
<li>Technicals</li>
<li>Feeds</li>
<li>Optimizer</li>
</ul>
</div></blockquote>
<dl class="docutils">
<dt>Strategies</dt>
<dd>These are the classes that you define, that implement a certain trading strategy. When to buy, when to sell, etc.</dd>
<dt>Technicals</dt>
<dd>These are a set of filters that you use to make calculations over a stream of values to decide what to do.
For example SMA (Simple Moving Average), RSI (Relative Strength Index), etc.</dd>
<dt>Feeds</dt>
<dd>These are data providing abstractions. For example, you&#8217;ll use a CSV feed that loads bars from a CSV
(Comma-separated values) formatted file to feed data to a strategy.</dd>
<dt>Optimizer</dt>
<dd>These are a set of classes that allow you to distribute backtesting among different computers,
or different processes running in the same computer, or a combination of both. They make horizontal scaling easy.</dd>
</dl>
<p>Having said all that, the first thing that we&#8217;ll need to test our strategy is some data.
Let&#8217;s use Oracle&#8217;s stock prices for year 2000, which we&#8217;ll download with the following command:</p>
<div class="highlight-python"><pre>python -c "from pyalgotrade.tools import yahoofinance; print yahoofinance.get_daily_csv('orcl', 2000)"</pre>
</div>
<p>The output should look like this:</p>
<div class="highlight-python"><pre>Date,Open,High,Low,Close,Volume,Adj Close
2000-12-29,30.87,31.31,28.69,29.06,31655500,28.35
2000-12-28,30.56,31.12,30.37,31.06,25055600,30.30
2000-12-27,30.37,31.06,29.37,30.69,26441700,29.94
.
.
2000-01-04,115.50,118.62,105.00,107.69,116850000,26.26
2000-01-03,124.62,125.19,111.62,118.12,98122000,28.81</pre>
</div>
<p>The pyalgotrade.tools.yahoofinance package downloads CSV formatted data from Yahoo! Finance.
Let&#8217;s save that as orcl-2000.csv with the following command:</p>
<div class="highlight-python"><pre>python -c "from pyalgotrade.tools import yahoofinance; print yahoofinance.get_daily_csv('orcl', 2000)" &gt; orcl-2000.csv</pre>
</div>
<p>Let&#8217;s start with a simple strategy, that is, one that just prints closing prices as they are processed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyalgotrade</span> <span class="kn">import</span> <span class="n">strategy</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.barfeed</span> <span class="kn">import</span> <span class="n">yahoofeed</span>

<span class="k">class</span> <span class="nc">MyStrategy</span><span class="p">(</span><span class="n">strategy</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">):</span>
        <span class="n">strategy</span><span class="o">.</span><span class="n">Strategy</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">onBars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bars</span><span class="p">):</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">bars</span><span class="o">.</span><span class="n">getBar</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">getDateTime</span><span class="p">(),</span> <span class="n">bar</span><span class="o">.</span><span class="n">getClose</span><span class="p">())</span>

<span class="c"># Load the yahoo feed from the CSV file</span>
<span class="n">feed</span> <span class="o">=</span> <span class="n">yahoofeed</span><span class="o">.</span><span class="n">Feed</span><span class="p">()</span>
<span class="n">feed</span><span class="o">.</span><span class="n">addBarsFromCSV</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">,</span> <span class="s">&quot;orcl-2000.csv&quot;</span><span class="p">)</span>

<span class="c"># Evaluate the strategy with the feed&#39;s bars.</span>
<span class="n">myStrategy</span> <span class="o">=</span> <span class="n">MyStrategy</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>
<span class="n">myStrategy</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<dl class="docutils">
<dt>The code is doing 3 main things:</dt>
<dd><ol class="first last arabic simple">
<li>Declaring a new strategy. There is only one method that has to be defined, <em>onBars</em>, which is called for every bar in the feed.</li>
<li>Loading the feed from a CSV file.</li>
<li>Running the strategy with the bars supplied by the feed.</li>
</ol>
</dd>
</dl>
<p>If you run the script you should see the closing prices in order:</p>
<div class="highlight-python"><pre>2000-01-03 00:00:00: 118.12
2000-01-04 00:00:00: 107.69
.
.
2000-12-28 00:00:00: 31.06
2000-12-29 00:00:00: 29.06</pre>
</div>
<p>Let&#8217;s move on with a strategy that prints closing SMA prices, to illustrate how technicals are used:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyalgotrade</span> <span class="kn">import</span> <span class="n">strategy</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.barfeed</span> <span class="kn">import</span> <span class="n">yahoofeed</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.technical</span> <span class="kn">import</span> <span class="n">ma</span>

<span class="k">class</span> <span class="nc">MyStrategy</span><span class="p">(</span><span class="n">strategy</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">):</span>
        <span class="n">strategy</span><span class="o">.</span><span class="n">Strategy</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
        <span class="c"># We want a 15 period SMA over the closing prices.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sma</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">getDataSeries</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getCloseDataSeries</span><span class="p">(),</span> <span class="mi">15</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">onBars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bars</span><span class="p">):</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">bars</span><span class="o">.</span><span class="n">getBar</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">getDateTime</span><span class="p">(),</span> <span class="n">bar</span><span class="o">.</span><span class="n">getClose</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sma</span><span class="o">.</span><span class="n">getValue</span><span class="p">())</span>

<span class="c"># Load the yahoo feed from the CSV file</span>
<span class="n">feed</span> <span class="o">=</span> <span class="n">yahoofeed</span><span class="o">.</span><span class="n">Feed</span><span class="p">()</span>
<span class="n">feed</span><span class="o">.</span><span class="n">addBarsFromCSV</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">,</span> <span class="s">&quot;orcl-2000.csv&quot;</span><span class="p">)</span>

<span class="c"># Evaluate the strategy with the feed&#39;s bars.</span>
<span class="n">myStrategy</span> <span class="o">=</span> <span class="n">MyStrategy</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>
<span class="n">myStrategy</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>This is very similar to the previous example, except that:</p>
<blockquote>
<div><ol class="arabic simple">
<li>We&#8217;re initializing an SMA filter over the closing price data series.</li>
<li>We&#8217;re printing the current SMA value along with the closing price.</li>
</ol>
</div></blockquote>
<p>If you run the script you should see the closing prices and the corresponding SMA values, but in this case the first 14 SMA values are None.
That is because we need at least 15 values to get something out of the SMA:</p>
<div class="highlight-python"><pre>2000-01-03 00:00:00: 118.12 None
2000-01-04 00:00:00: 107.69 None
2000-01-05 00:00:00: 102.0 None
2000-01-06 00:00:00: 96.0 None
2000-01-07 00:00:00: 103.37 None
2000-01-10 00:00:00: 115.75 None
2000-01-11 00:00:00: 112.37 None
2000-01-12 00:00:00: 105.62 None
2000-01-13 00:00:00: 105.06 None
2000-01-14 00:00:00: 106.81 None
2000-01-18 00:00:00: 111.25 None
2000-01-19 00:00:00: 57.13 None
2000-01-20 00:00:00: 59.25 None
2000-01-21 00:00:00: 59.69 None
2000-01-24 00:00:00: 54.19 94.2866666667
2000-01-25 00:00:00: 56.44 90.1746666667
.
.
2000-12-28 00:00:00: 31.06 30.0446666667
2000-12-29 00:00:00: 29.06 30.0946666667</pre>
</div>
<p>All the technicals will return None when the value can&#8217;t be calculated at a given time.</p>
<p>One important thing about technicals is that they can be stacked. That is because they&#8217;re modeled as data series too.
For example, getting an SMA over the RSI over the closing prices is as simple as this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyalgotrade</span> <span class="kn">import</span> <span class="n">strategy</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.barfeed</span> <span class="kn">import</span> <span class="n">yahoofeed</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.technical</span> <span class="kn">import</span> <span class="n">ma</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.technical</span> <span class="kn">import</span> <span class="n">rsi</span>

<span class="k">class</span> <span class="nc">MyStrategy</span><span class="p">(</span><span class="n">strategy</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">):</span>
        <span class="n">strategy</span><span class="o">.</span><span class="n">Strategy</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__rsi</span> <span class="o">=</span> <span class="n">rsi</span><span class="o">.</span><span class="n">RSI</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">getDataSeries</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getCloseDataSeries</span><span class="p">(),</span> <span class="mi">14</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sma</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__rsi</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">onBars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bars</span><span class="p">):</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">bars</span><span class="o">.</span><span class="n">getBar</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">getDateTime</span><span class="p">(),</span> <span class="n">bar</span><span class="o">.</span><span class="n">getClose</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rsi</span><span class="o">.</span><span class="n">getValue</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sma</span><span class="o">.</span><span class="n">getValue</span><span class="p">())</span>

<span class="c"># Load the yahoo feed from the CSV file</span>
<span class="n">feed</span> <span class="o">=</span> <span class="n">yahoofeed</span><span class="o">.</span><span class="n">Feed</span><span class="p">()</span>
<span class="n">feed</span><span class="o">.</span><span class="n">addBarsFromCSV</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">,</span> <span class="s">&quot;orcl-2000.csv&quot;</span><span class="p">)</span>

<span class="c"># Evaluate the strategy with the feed&#39;s bars.</span>
<span class="n">myStrategy</span> <span class="o">=</span> <span class="n">MyStrategy</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span>
<span class="n">myStrategy</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>If you run the script you should see a bunch of values on the screen where:</p>
<blockquote>
<div><ul class="simple">
<li>The first 14 RSI values are None. That is because we need at least 15 values to get an RSI value.</li>
<li>The first 28 SMA values are None. That is because the first 14 RSI values are None, and the 15th one is the first not None value that the SMA filter receives.
Only when we have 15 not None values we can calculate the SMA(15).</li>
</ul>
</div></blockquote>
<div class="highlight-python"><pre>2000-01-03 00:00:00: 118.12 None None
2000-01-04 00:00:00: 107.69 None None
2000-01-05 00:00:00: 102.0 None None
2000-01-06 00:00:00: 96.0 None None
2000-01-07 00:00:00: 103.37 None None
2000-01-10 00:00:00: 115.75 None None
2000-01-11 00:00:00: 112.37 None None
2000-01-12 00:00:00: 105.62 None None
2000-01-13 00:00:00: 105.06 None None
2000-01-14 00:00:00: 106.81 None None
2000-01-18 00:00:00: 111.25 None None
2000-01-19 00:00:00: 57.13 None None
2000-01-20 00:00:00: 59.25 None None
2000-01-21 00:00:00: 59.69 None None
2000-01-24 00:00:00: 54.19 23.5673530141 None
2000-01-25 00:00:00: 56.44 25.0687519877 None
2000-01-26 00:00:00: 55.06 24.7476577095 None
2000-01-27 00:00:00: 51.81 23.9690136517 None
2000-01-28 00:00:00: 47.38 22.9108539956 None
2000-01-31 00:00:00: 49.95 24.980004823 None
2000-02-01 00:00:00: 54.0 28.2484181864 None
2000-02-02 00:00:00: 54.31 28.505177315 None
2000-02-03 00:00:00: 56.69 30.5596770599 None
2000-02-04 00:00:00: 57.81 31.5564353751 None
2000-02-07 00:00:00: 59.94 33.5111056589 None
2000-02-08 00:00:00: 59.56 33.3282358994 None
2000-02-09 00:00:00: 59.94 33.7177605915 None
2000-02-10 00:00:00: 62.31 36.2205441255 None
2000-02-11 00:00:00: 59.69 34.6623493641 29.0368892505
2000-02-14 00:00:00: 62.19 37.4284445543 29.9609620198
.
.
2000-12-28 00:00:00: 31.06 52.1646203455 49.997518354
2000-12-29 00:00:00: 29.06 47.3776678335 50.0790646925</pre>
</div>
<div class="section" id="trading">
<h2>Trading<a class="headerlink" href="#trading" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s move on with a simple strategy, this time simulating actual trading. The idea is very simple:</p>
<blockquote>
<div><ul class="simple">
<li>If the closing price is above the SMA(15) we enter a long position (we place a buy market order).</li>
<li>If a long order is in place, and the closing price drops below the SMA(15) we exit the long position (we place a sell market order).</li>
</ul>
</div></blockquote>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyalgotrade</span> <span class="kn">import</span> <span class="n">strategy</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.barfeed</span> <span class="kn">import</span> <span class="n">yahoofeed</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.technical</span> <span class="kn">import</span> <span class="n">ma</span>

<span class="k">class</span> <span class="nc">MyStrategy</span><span class="p">(</span><span class="n">strategy</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">smaPeriod</span><span class="p">):</span>
        <span class="n">strategy</span><span class="o">.</span><span class="n">Strategy</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sma</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">getDataSeries</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getCloseDataSeries</span><span class="p">(),</span> <span class="n">smaPeriod</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__position</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">onStart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;Initial portfolio value: $</span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBroker</span><span class="p">()</span><span class="o">.</span><span class="n">getCash</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">onEnterOk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="n">execInfo</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">getEntryOrder</span><span class="p">()</span><span class="o">.</span><span class="n">getExecutionInfo</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: BUY at $</span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">execInfo</span><span class="o">.</span><span class="n">getDateTime</span><span class="p">(),</span> <span class="n">execInfo</span><span class="o">.</span><span class="n">getPrice</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">onEnterCanceled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__position</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">onExitOk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="n">execInfo</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">getExitOrder</span><span class="p">()</span><span class="o">.</span><span class="n">getExecutionInfo</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: SELL at $</span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">execInfo</span><span class="o">.</span><span class="n">getDateTime</span><span class="p">(),</span> <span class="n">execInfo</span><span class="o">.</span><span class="n">getPrice</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__position</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">onExitCanceled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="c"># If the exit was canceled, re-submit it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exitPosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__position</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">onBars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bars</span><span class="p">):</span>
        <span class="c"># Wait for enough bars to be available to calculate a SMA.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sma</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">bar</span> <span class="o">=</span> <span class="n">bars</span><span class="o">.</span><span class="n">getBar</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">)</span>
        <span class="c"># If a position was not opened, check if we should enter a long position.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__position</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bar</span><span class="o">.</span><span class="n">getClose</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sma</span><span class="o">.</span><span class="n">getValue</span><span class="p">():</span>
                <span class="c"># Enter a buy market order for 10 orcl shares. The order is good till canceled.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enterLong</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="c"># Check if we have to exit the position.</span>
        <span class="k">elif</span> <span class="n">bar</span><span class="o">.</span><span class="n">getClose</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sma</span><span class="o">.</span><span class="n">getValue</span><span class="p">():</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">exitPosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__position</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">onFinish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bars</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;Final portfolio value: $</span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBroker</span><span class="p">()</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">bars</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run_strategy</span><span class="p">(</span><span class="n">smaPeriod</span><span class="p">):</span>
    <span class="c"># Load the yahoo feed from the CSV file</span>
    <span class="n">feed</span> <span class="o">=</span> <span class="n">yahoofeed</span><span class="o">.</span><span class="n">Feed</span><span class="p">()</span>
    <span class="n">feed</span><span class="o">.</span><span class="n">addBarsFromCSV</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">,</span> <span class="s">&quot;orcl-2000.csv&quot;</span><span class="p">)</span>

    <span class="c"># Evaluate the strategy with the feed&#39;s bars.</span>
    <span class="n">myStrategy</span> <span class="o">=</span> <span class="n">MyStrategy</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">smaPeriod</span><span class="p">)</span>
    <span class="n">myStrategy</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="n">run_strategy</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
<p>If you run the script you should see something like this:</p>
<div class="highlight-python"><pre>Initial portfolio value: $1000.00
2000-02-08 00:00:00: BUY at $60.75
2000-02-22 00:00:00: SELL at $59.13
2000-02-23 00:00:00: BUY at $60.19
2000-03-31 00:00:00: SELL at $80.19
2000-04-07 00:00:00: BUY at $83.69
2000-04-12 00:00:00: SELL at $77.94
2000-04-19 00:00:00: BUY at $78.62
2000-04-20 00:00:00: SELL at $73.81
2000-04-28 00:00:00: BUY at $78.50
2000-05-05 00:00:00: SELL at $74.00
2000-05-08 00:00:00: BUY at $75.31
2000-05-09 00:00:00: SELL at $73.69
2000-05-16 00:00:00: BUY at $77.62
2000-05-19 00:00:00: SELL at $72.00
2000-05-31 00:00:00: BUY at $73.25
2000-06-23 00:00:00: SELL at $80.81
2000-06-27 00:00:00: BUY at $82.37
2000-06-28 00:00:00: SELL at $82.06
2000-06-29 00:00:00: BUY at $82.06
2000-06-30 00:00:00: SELL at $80.37
2000-07-03 00:00:00: BUY at $81.12
2000-07-05 00:00:00: SELL at $76.81
2000-07-21 00:00:00: BUY at $77.44
2000-07-24 00:00:00: SELL at $77.12
2000-07-26 00:00:00: BUY at $74.81
2000-07-28 00:00:00: SELL at $75.12
2000-08-01 00:00:00: BUY at $75.19
2000-08-02 00:00:00: SELL at $73.00
2000-08-04 00:00:00: BUY at $78.31
2000-09-11 00:00:00: SELL at $86.06
2000-09-29 00:00:00: BUY at $81.36
2000-10-02 00:00:00: SELL at $79.75
2000-11-20 00:00:00: BUY at $24.31
2000-11-21 00:00:00: SELL at $24.81
2000-12-01 00:00:00: BUY at $26.37
2000-12-15 00:00:00: SELL at $29.44
2000-12-18 00:00:00: BUY at $30.00
2000-12-21 00:00:00: SELL at $27.81
2000-12-22 00:00:00: BUY at $30.37
Final portfolio value: $1013.40</pre>
</div>
<p>But what if we used 30 as the SMA period instead of 15 ? Would that yield better results or worse ?
We could certainly do something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">):</span>
    <span class="n">run_strategy</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
<p>and we would find out that we can get better results with a SMA(20):</p>
<div class="highlight-python"><pre>Final portfolio value: $1124.90</pre>
</div>
<p>This is ok if we only have to try a limited set of parameters values. But if we have to test a strategy with multiple
parameters, then the serial approach is definitely not going to scale as strategies get more complex.</p>
</div>
<div class="section" id="optimizing">
<h2>Optimizing<a class="headerlink" href="#optimizing" title="Permalink to this headline">¶</a></h2>
<p>Meet the optimizer component. The idea is very simple:</p>
<blockquote>
<div><ul>
<li><dl class="first docutils">
<dt>There is one server responsible for:</dt>
<dd><ul class="first last simple">
<li>Providing the bars to run the strategy.</li>
<li>Providing the parameters to run the strategy.</li>
<li>Recording the strategy results from each of the workers.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>There are multiple workers responsible for:</dt>
<dd><ul class="first last simple">
<li>Running the strategy with the bars and parameters provided by the server.</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>To illustrate this we&#8217;ll use a strategy known as RSI2 (<a class="reference external" href="http://stockcharts.com/school/doku.php?id=chart_school:trading_strategies:rsi2">http://stockcharts.com/school/doku.php?id=chart_school:trading_strategies:rsi2</a>)
which requires the following parameters:</p>
<blockquote>
<div><ul class="simple">
<li>An SMA period for trend identification. We&#8217;ll call this entrySMA and will range between 150 and 250.</li>
<li>A smaller SMA period for the exit point. We&#8217;ll call this exitSMA and will range between 5 and 15.</li>
<li>An RSI period for entering both short/long positions. We&#8217;ll call this rsiPeriod and will range between 2 and 10.</li>
<li>An RSI oversold threshold for long position entry. We&#8217;ll call this overSoldThreshold and will range between 5 and 25.</li>
<li>An RSI overbought threshold for short position entry. We&#8217;ll call this overBoughtThreshold and will range between 75 and 95.</li>
</ul>
</div></blockquote>
<p>If my math is ok, those are 4409559 different combinations.</p>
<p>Testing this strategy for one set of parameters took me about 0.16 seconds. If I execute all the combinations serially
it&#8217;ll take me about 8.5 days to evaluate all of them and find the best set of parameters. That is a long time, but
if I can get ten 8-core computers to do the job then the total time will go down to about 2.5 hours.</p>
<p>Long story short, <strong>we need to go parallel</strong>.</p>
<p>Let&#8217;s start by downloading 3 years of daily bars for &#8216;Dow Jones Industrial Average&#8217;:</p>
<div class="highlight-python"><pre>python -c "from pyalgotrade.tools import yahoofinance; print yahoofinance.get_daily_csv('dia', 2009)" &gt; dia-2009.csv
python -c "from pyalgotrade.tools import yahoofinance; print yahoofinance.get_daily_csv('dia', 2010)" &gt; dia-2010.csv
python -c "from pyalgotrade.tools import yahoofinance; print yahoofinance.get_daily_csv('dia', 2011)" &gt; dia-2011.csv</pre>
</div>
<p>This is the server script:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.barfeed</span> <span class="kn">import</span> <span class="n">yahoofeed</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.optimizer</span> <span class="kn">import</span> <span class="n">server</span>

<span class="k">def</span> <span class="nf">parameters_generator</span><span class="p">():</span>
    <span class="n">entrySMA</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">251</span><span class="p">)</span>
    <span class="n">exitSMA</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">rsiPeriod</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
    <span class="n">overBoughtThreshold</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span>
    <span class="n">overSoldThreshold</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">entrySMA</span><span class="p">,</span> <span class="n">exitSMA</span><span class="p">,</span> <span class="n">rsiPeriod</span><span class="p">,</span> <span class="n">overBoughtThreshold</span><span class="p">,</span> <span class="n">overSoldThreshold</span><span class="p">)</span>

<span class="c"># The if __name__ == &#39;__main__&#39; part is necessary if running on Windows.</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c"># Load the feed from the CSV files.</span>
    <span class="n">feed</span> <span class="o">=</span> <span class="n">yahoofeed</span><span class="o">.</span><span class="n">Feed</span><span class="p">()</span>
    <span class="n">feed</span><span class="o">.</span><span class="n">addBarsFromCSV</span><span class="p">(</span><span class="s">&quot;dia&quot;</span><span class="p">,</span> <span class="s">&quot;dia-2009.csv&quot;</span><span class="p">)</span>
    <span class="n">feed</span><span class="o">.</span><span class="n">addBarsFromCSV</span><span class="p">(</span><span class="s">&quot;dia&quot;</span><span class="p">,</span> <span class="s">&quot;dia-2010.csv&quot;</span><span class="p">)</span>
    <span class="n">feed</span><span class="o">.</span><span class="n">addBarsFromCSV</span><span class="p">(</span><span class="s">&quot;dia&quot;</span><span class="p">,</span> <span class="s">&quot;dia-2011.csv&quot;</span><span class="p">)</span>

    <span class="c"># Run the server.</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">parameters_generator</span><span class="p">(),</span> <span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
</pre></div>
</div>
<p>The server code is doing 3 things:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Declaring a generator function that builds parameters.</li>
<li>Loading the feed with the CSV files we downloaded.</li>
<li>Running the server that will wait for incoming connections on port 5000.</li>
</ol>
</div></blockquote>
<p>This is the worker script:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyalgotrade.optimizer</span> <span class="kn">import</span> <span class="n">worker</span>
<span class="kn">from</span> <span class="nn">pyalgotrade</span> <span class="kn">import</span> <span class="n">strategy</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.technical</span> <span class="kn">import</span> <span class="n">ma</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.technical</span> <span class="kn">import</span> <span class="n">rsi</span>

<span class="k">class</span> <span class="nc">MyStrategy</span><span class="p">(</span><span class="n">strategy</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">entrySMA</span><span class="p">,</span> <span class="n">exitSMA</span><span class="p">,</span> <span class="n">rsiPeriod</span><span class="p">,</span> <span class="n">overBoughtThreshold</span><span class="p">,</span> <span class="n">overSoldThreshold</span><span class="p">):</span>
        <span class="n">strategy</span><span class="o">.</span><span class="n">Strategy</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">getDataSeries</span><span class="p">(</span><span class="s">&quot;dia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getCloseDataSeries</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__entrySMA</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">entrySMA</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__exitSMA</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">exitSMA</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__rsi</span> <span class="o">=</span> <span class="n">rsi</span><span class="o">.</span><span class="n">RSI</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">rsiPeriod</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__overBoughtThreshold</span> <span class="o">=</span> <span class="n">overBoughtThreshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__overSoldThreshold</span> <span class="o">=</span> <span class="n">overSoldThreshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">onEnterOk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">onEnterCanceled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span> <span class="o">==</span> <span class="n">position</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span> <span class="o">==</span> <span class="n">position</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">onExitOk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span> <span class="o">==</span> <span class="n">position</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span> <span class="o">==</span> <span class="n">position</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">onExitCanceled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="c"># If the exit was canceled, re-submit it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exitPosition</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">onBars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bars</span><span class="p">):</span>
        <span class="c"># Wait for enough bars to be available to calculate SMA and RSI.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exitSMA</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entrySMA</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rsi</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">bar</span> <span class="o">=</span> <span class="n">bars</span><span class="o">.</span><span class="n">getBar</span><span class="p">(</span><span class="s">&quot;dia&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitLongSignal</span><span class="p">(</span><span class="n">bar</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exitPosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitShortSignal</span><span class="p">(</span><span class="n">bar</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exitPosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enterLongSignal</span><span class="p">(</span><span class="n">bar</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enterLong</span><span class="p">(</span><span class="s">&quot;dia&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">enterShortSignal</span><span class="p">(</span><span class="n">bar</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enterShort</span><span class="p">(</span><span class="s">&quot;dia&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">enterLongSignal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bar</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">bar</span><span class="o">.</span><span class="n">getClose</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entrySMA</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rsi</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__overSoldThreshold</span>

    <span class="k">def</span> <span class="nf">exitLongSignal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bar</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">bar</span><span class="o">.</span><span class="n">getClose</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exitSMA</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">enterShortSignal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bar</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">bar</span><span class="o">.</span><span class="n">getClose</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entrySMA</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rsi</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__overBoughtThreshold</span>

    <span class="k">def</span> <span class="nf">exitShortSignal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bar</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">bar</span><span class="o">.</span><span class="n">getClose</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exitSMA</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>

<span class="c"># The if __name__ == &#39;__main__&#39; part is necessary if running on Windows.</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">MyStrategy</span><span class="p">,</span> <span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
</pre></div>
</div>
<p>The worker code is doing 2 things:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Declaring the RSI2 strategy.</li>
<li>Using pyalgotrade.optimizer.worker module to run the strategy in parallel with the data supplied by the server.</li>
</ol>
</div></blockquote>
<p>When you run the server and the client/s you&#8217;ll see something like this on the server console:</p>
<div class="highlight-python"><pre>INFO 2012-03-24 22:29:29,860: Loading bars
INFO 2012-03-24 22:29:30,053: Waiting for workers
INFO 2012-03-24 22:29:33,640: Partial result $2036.90 with parameters: (150, 5, 2, 75, 5)
INFO 2012-03-24 22:29:33,769: Partial result $2089.20 with parameters: (150, 5, 2, 76, 5)
INFO 2012-03-24 22:29:33,896: Partial result $2100.40 with parameters: (150, 5, 2, 77, 5)
INFO 2012-03-24 22:29:34,025: Partial result $2100.40 with parameters: (150, 5, 2, 78, 5)
INFO 2012-03-24 22:29:34,153: Partial result $2100.40 with parameters: (150, 5, 2, 79, 5)
INFO 2012-03-24 22:29:34,280: Partial result $2112.20 with parameters: (150, 5, 2, 80, 5)
.
.</pre>
</div>
<p>and something like this on the worker/s console:</p>
<div class="highlight-python"><pre>INFO 2012-03-24 22:29:33,515: Running strategy with parameters (150, 5, 2, 75, 5)
INFO 2012-03-24 22:29:33,638: Result 2036.9
INFO 2012-03-24 22:29:33,643: Running strategy with parameters (150, 5, 2, 76, 5)
INFO 2012-03-24 22:29:33,767: Result 2089.2
INFO 2012-03-24 22:29:33,772: Running strategy with parameters (150, 5, 2, 77, 5)
INFO 2012-03-24 22:29:33,895: Result 2100.4
INFO 2012-03-24 22:29:33,899: Running strategy with parameters (150, 5, 2, 78, 5)
INFO 2012-03-24 22:29:34,023: Result 2100.4
INFO 2012-03-24 22:29:34,028: Running strategy with parameters (150, 5, 2, 79, 5)
INFO 2012-03-24 22:29:34,151: Result 2100.4
INFO 2012-03-24 22:29:34,156: Running strategy with parameters (150, 5, 2, 80, 5)
INFO 2012-03-24 22:29:34,278: Result 2112.2
.
.</pre>
</div>
<p>Note that you should run <strong>only one server and one or more workers in different computers</strong>.</p>
<p>If you just want to run strategies in parallel in your own desktop you can take advantage of the pyalgotrade.optimizer.local
module like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.optimizer</span> <span class="kn">import</span> <span class="n">local</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.barfeed</span> <span class="kn">import</span> <span class="n">yahoofeed</span>
<span class="kn">from</span> <span class="nn">pyalgotrade</span> <span class="kn">import</span> <span class="n">strategy</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.technical</span> <span class="kn">import</span> <span class="n">ma</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.technical</span> <span class="kn">import</span> <span class="n">rsi</span>

<span class="k">class</span> <span class="nc">MyStrategy</span><span class="p">(</span><span class="n">strategy</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">entrySMA</span><span class="p">,</span> <span class="n">exitSMA</span><span class="p">,</span> <span class="n">rsiPeriod</span><span class="p">,</span> <span class="n">overBoughtThreshold</span><span class="p">,</span> <span class="n">overSoldThreshold</span><span class="p">):</span>
        <span class="n">strategy</span><span class="o">.</span><span class="n">Strategy</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">getDataSeries</span><span class="p">(</span><span class="s">&quot;dia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getCloseDataSeries</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__entrySMA</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">entrySMA</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__exitSMA</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">exitSMA</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__rsi</span> <span class="o">=</span> <span class="n">rsi</span><span class="o">.</span><span class="n">RSI</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">rsiPeriod</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__overBoughtThreshold</span> <span class="o">=</span> <span class="n">overBoughtThreshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__overSoldThreshold</span> <span class="o">=</span> <span class="n">overSoldThreshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">onEnterOk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">onEnterCanceled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span> <span class="o">==</span> <span class="n">position</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span> <span class="o">==</span> <span class="n">position</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">onExitOk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span> <span class="o">==</span> <span class="n">position</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span> <span class="o">==</span> <span class="n">position</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">onExitCanceled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="c"># If the exit was canceled, re-submit it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exitPosition</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">onBars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bars</span><span class="p">):</span>
        <span class="c"># Wait for enough bars to be available to calculate SMA and RSI.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exitSMA</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entrySMA</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rsi</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">bar</span> <span class="o">=</span> <span class="n">bars</span><span class="o">.</span><span class="n">getBar</span><span class="p">(</span><span class="s">&quot;dia&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitLongSignal</span><span class="p">(</span><span class="n">bar</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exitPosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exitShortSignal</span><span class="p">(</span><span class="n">bar</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exitPosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enterLongSignal</span><span class="p">(</span><span class="n">bar</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__longPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enterLong</span><span class="p">(</span><span class="s">&quot;dia&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">enterShortSignal</span><span class="p">(</span><span class="n">bar</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__shortPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enterShort</span><span class="p">(</span><span class="s">&quot;dia&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">enterLongSignal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bar</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">bar</span><span class="o">.</span><span class="n">getClose</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entrySMA</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rsi</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__overSoldThreshold</span>

    <span class="k">def</span> <span class="nf">exitLongSignal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bar</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">bar</span><span class="o">.</span><span class="n">getClose</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exitSMA</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">enterShortSignal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bar</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">bar</span><span class="o">.</span><span class="n">getClose</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entrySMA</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rsi</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__overBoughtThreshold</span>

    <span class="k">def</span> <span class="nf">exitShortSignal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bar</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">bar</span><span class="o">.</span><span class="n">getClose</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exitSMA</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">parameters_generator</span><span class="p">():</span>
    <span class="n">entrySMA</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">251</span><span class="p">)</span>
    <span class="n">exitSMA</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">rsiPeriod</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
    <span class="n">overBoughtThreshold</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span>
    <span class="n">overSoldThreshold</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">entrySMA</span><span class="p">,</span> <span class="n">exitSMA</span><span class="p">,</span> <span class="n">rsiPeriod</span><span class="p">,</span> <span class="n">overBoughtThreshold</span><span class="p">,</span> <span class="n">overSoldThreshold</span><span class="p">)</span>

<span class="c"># The if __name__ == &#39;__main__&#39; part is necessary if running on Windows.</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c"># Load the feed from the CSV files.</span>
    <span class="n">feed</span> <span class="o">=</span> <span class="n">yahoofeed</span><span class="o">.</span><span class="n">Feed</span><span class="p">()</span>
    <span class="n">feed</span><span class="o">.</span><span class="n">addBarsFromCSV</span><span class="p">(</span><span class="s">&quot;dia&quot;</span><span class="p">,</span> <span class="s">&quot;dia-2009.csv&quot;</span><span class="p">)</span>
    <span class="n">feed</span><span class="o">.</span><span class="n">addBarsFromCSV</span><span class="p">(</span><span class="s">&quot;dia&quot;</span><span class="p">,</span> <span class="s">&quot;dia-2010.csv&quot;</span><span class="p">)</span>
    <span class="n">feed</span><span class="o">.</span><span class="n">addBarsFromCSV</span><span class="p">(</span><span class="s">&quot;dia&quot;</span><span class="p">,</span> <span class="s">&quot;dia-2011.csv&quot;</span><span class="p">)</span>

    <span class="n">local</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">MyStrategy</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">parameters_generator</span><span class="p">())</span>
</pre></div>
</div>
<p>The code is doing 4 things:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Declaring the RSI2 strategy.</li>
<li>Declaring a generator function that builds parameters.</li>
<li>Loading the feed with the CSV files we downloaded.</li>
<li>Using the pyalgotrade.optimizer.local module to run the strategy in parallel and find the best result.</li>
</ol>
</div></blockquote>
<p>When you run this code you should see something like this:</p>
<div class="highlight-python"><pre>INFO 2012-03-25 00:07:34,793: Loading bars
INFO 2012-03-25 00:07:34,996: Waiting for workers
INFO 2012-03-25 00:07:35,366: Partial result $2036.90 with parameters: (150, 5, 2, 75, 5)
INFO 2012-03-25 00:07:35,385: Partial result $2089.20 with parameters: (150, 5, 2, 76, 5)
INFO 2012-03-25 00:07:35,499: Partial result $2100.40 with parameters: (150, 5, 2, 77, 5)
INFO 2012-03-25 00:07:35,515: Partial result $2100.40 with parameters: (150, 5, 2, 78, 5)
INFO 2012-03-25 00:07:35,632: Partial result $2100.40 with parameters: (150, 5, 2, 79, 5)
INFO 2012-03-25 00:07:35,646: Partial result $2112.20 with parameters: (150, 5, 2, 80, 5)
INFO 2012-03-25 00:07:35,763: Partial result $2115.50 with parameters: (150, 5, 2, 81, 5)
INFO 2012-03-25 00:07:35,775: Partial result $2076.60 with parameters: (150, 5, 2, 82, 5)
INFO 2012-03-25 00:07:35,895: Partial result $2003.60 with parameters: (150, 5, 2, 83, 5)
INFO 2012-03-25 00:07:35,902: Partial result $2003.60 with parameters: (150, 5, 2, 84, 5)
INFO 2012-03-25 00:07:36,026: Partial result $2003.60 with parameters: (150, 5, 2, 85, 5)
INFO 2012-03-25 00:07:36,033: Partial result $2048.60 with parameters: (150, 5, 2, 86, 5)
INFO 2012-03-25 00:07:36,157: Partial result $2061.70 with parameters: (150, 5, 2, 87, 5)
INFO 2012-03-25 00:07:36,163: Partial result $2075.00 with parameters: (150, 5, 2, 88, 5)
INFO 2012-03-25 00:07:36,288: Partial result $2082.00 with parameters: (150, 5, 2, 89, 5)
INFO 2012-03-25 00:07:36,293: Partial result $2080.70 with parameters: (150, 5, 2, 90, 5)
INFO 2012-03-25 00:07:36,418: Partial result $2086.80 with parameters: (150, 5, 2, 91, 5)
INFO 2012-03-25 00:07:36,424: Partial result $2086.80 with parameters: (150, 5, 2, 92, 5)
.
.</pre>
</div>
<dl class="docutils">
<dt>For the record, the best result found was $2314.40 with the following parameters:</dt>
<dd><ol class="first last arabic simple">
<li>entrySMA: 154</li>
<li>exitSMA: 5</li>
<li>rsiPeriod: 2</li>
<li>overBoughtThreshold: 91</li>
<li>overSoldThreshold: 18</li>
</ol>
</dd>
</dl>
<p>If you don&#8217;t have access to a cluster of computers, then you can take advantage of <a class="reference internal" href="googleappengine.html"><em>Google App Engine support</em></a>.</p>
</div>
<div class="section" id="plotting">
<h2>Plotting<a class="headerlink" href="#plotting" title="Permalink to this headline">¶</a></h2>
<p>PyAlgoTrade makes it very easy to plot a strategy execution.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyalgotrade</span> <span class="kn">import</span> <span class="n">strategy</span>
<span class="kn">from</span> <span class="nn">pyalgotrade</span> <span class="kn">import</span> <span class="n">plotter</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.barfeed</span> <span class="kn">import</span> <span class="n">yahoofeed</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.technical</span> <span class="kn">import</span> <span class="n">ma</span>
<span class="kn">from</span> <span class="nn">pyalgotrade.technical</span> <span class="kn">import</span> <span class="n">cross</span>

<span class="k">class</span> <span class="nc">MyStrategy</span><span class="p">(</span><span class="n">strategy</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="n">smaPeriod</span><span class="p">):</span>
		<span class="n">strategy</span><span class="o">.</span><span class="n">Strategy</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="n">closeDS</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">getDataSeries</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getCloseDataSeries</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__sma</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">closeDS</span><span class="p">,</span> <span class="n">smaPeriod</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__crossAbove</span> <span class="o">=</span> <span class="n">cross</span><span class="o">.</span><span class="n">CrossAbove</span><span class="p">(</span><span class="n">closeDS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sma</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__crossBelow</span> <span class="o">=</span> <span class="n">cross</span><span class="o">.</span><span class="n">CrossBelow</span><span class="p">(</span><span class="n">closeDS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sma</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__position</span> <span class="o">=</span> <span class="bp">None</span>

	<span class="k">def</span> <span class="nf">getSMA</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sma</span>

	<span class="k">def</span> <span class="nf">onEnterCanceled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__position</span> <span class="o">=</span> <span class="bp">None</span>

	<span class="k">def</span> <span class="nf">onExitOk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__position</span> <span class="o">=</span> <span class="bp">None</span>

	<span class="k">def</span> <span class="nf">onExitCanceled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
		<span class="c"># If the exit was canceled, re-submit it.</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">exitPosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__position</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">onBars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bars</span><span class="p">):</span>
		<span class="c"># Wait for enough bars to be available to calculate the CrossAbove indicator.</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__crossAbove</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">return</span>

		<span class="c"># If a position was not opened, check if we should enter a long position.</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__position</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__crossAbove</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="c"># Enter a buy market order for 10 orcl shares. The order is good till canceled.</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">__position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enterLong</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
		<span class="c"># Check if we have to exit the position.</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__crossBelow</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			 <span class="bp">self</span><span class="o">.</span><span class="n">exitPosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__position</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">onFinish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bars</span><span class="p">):</span>
		<span class="k">print</span> <span class="s">&quot;Final portfolio value: $</span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getResult</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">run_strategy</span><span class="p">(</span><span class="n">smaPeriod</span><span class="p">):</span>
	<span class="c"># Load the yahoo feed from the CSV file</span>
	<span class="n">feed</span> <span class="o">=</span> <span class="n">yahoofeed</span><span class="o">.</span><span class="n">Feed</span><span class="p">()</span>
	<span class="n">feed</span><span class="o">.</span><span class="n">addBarsFromCSV</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">,</span> <span class="s">&quot;orcl-2000.csv&quot;</span><span class="p">)</span>

	<span class="c"># Evaluate the strategy with the feed&#39;s bars.</span>
	<span class="n">myStrategy</span> <span class="o">=</span> <span class="n">MyStrategy</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">smaPeriod</span><span class="p">)</span>
	<span class="c"># Attach the strategy to the plotter.</span>
	<span class="n">plt</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">StrategyPlotter</span><span class="p">(</span><span class="n">myStrategy</span><span class="p">)</span>
	<span class="c"># Include the SMA in the instrument&#39;s subplot to get it displayed along with the closing prices.</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">getInstrumentSubplot</span><span class="p">(</span><span class="s">&quot;orcl&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addDataSeries</span><span class="p">(</span><span class="s">&quot;SMA&quot;</span><span class="p">,</span> <span class="n">myStrategy</span><span class="o">.</span><span class="n">getSMA</span><span class="p">())</span>
	<span class="c"># Run the strategy.</span>
	<span class="n">myStrategy</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
	<span class="c"># Plot the strategy.</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">run_strategy</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p>The code is doing 4 things:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Declaring the strategy. In this case a simple SMA crossover.</li>
<li>Loading the feed from a CSV file.</li>
<li>Running the strategy with the bars supplied by the feed and a StrategyPlotter attached.</li>
<li>Plotting the strategy.</li>
</ol>
</div></blockquote>
<p>This is what the plot looks like:</p>
<img alt="_images/tutorial-5.png" src="_images/tutorial-5.png" />
<p>I hope you enjoyed this quick introduction. I&#8217;d recommend you to download PyAlgoTrade here: <a class="reference external" href="http://gbeced.github.com/pyalgotrade/downloads/index.html">http://gbeced.github.com/pyalgotrade/downloads/index.html</a>
and get started writing you own strategies.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tutorial</a><ul>
<li><a class="reference internal" href="#trading">Trading</a></li>
<li><a class="reference internal" href="#optimizing">Optimizing</a></li>
<li><a class="reference internal" href="#plotting">Plotting</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="intro.html"
                        title="previous chapter">Introduction</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="googleappengine.html"
                        title="next chapter">Google App Engine support</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/tutorial.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="googleappengine.html" title="Google App Engine support"
             >next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="Introduction"
             >previous</a> |</li>
        <li><a href="index.html">PyAlgoTrade 0.9 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Gabriel Martín Becedillas Ruiz.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>